## 네 개의 영역

> 표현, 응용, 도메인, 인프라스트럭처는 아키텍처를 설계할 때 출현하는 전형적인 네 가지 영역이다. 네 영역 중 표현 영역은 사용자의 요청을 받아 응용 영역에 전달하고 응용 영역의 처리 결과를 다시 사용자에게 보여주는 역할을 한다.

- 스프링 MVC 프레임워크가 `표현 영역`을 위한 기술.
- 웹 애플리케이션에서 표현 영역의 사용자는 웹 브라우저를 사용하는 사람일 수도 있고,  REST API를 호출하는 외부 시스템일 수도 있다.

```java
public class CacnelOrderService {
    Order order = findOrderById(orderId);
    if (order == null) throw new ORderNotFoundException(orderID);
    order.cancel(); // <<< 도메인에 위임한 부분
}
```

- `응용 서비스는 로직`을 직접 수행하기보다는 도메인 모델(Entity)에 로직 수행을 위임한다.

- `인프라스트럭처 영역`은 구현 기술에 대한 것을 다룸.
  + 이 영역은 RDBMS 연동을 처리하고, 메시징 큐에 메시지를 전송하거나 수신하는 기능을 구현하고, 몽고DB나 레디스의 데이터 연동을 처리한다.
  + 이 영역은 SMTP를 이용한 메일 발송 기능을 구현하거나 HTTP 클라이언트를 이용해서 REST API를 호출하는 것도 처리한다.

- 도메인 영역, 응용 영역, 표현 영역은 구현 기술을 사용한 코드로 직접 만들지 않는다.
  + 대신 인프라스트럭처 영역에서 제공하는 기능을 사용해서 필요한 기능을 개발.
  + 응용 영역에서 DB에 보관된 데이터가 필요하면 인프라스트럭처 영역의 DB 모듈을 사용하는 데이터를 읽어온다.

## 계층 구조 아키텍처
> 네 영역을 구성할 때 많이 사용하는 아키텍처가 `표현 >> 응용 >> 도메인 >> 인프라스트럭처` 구성이다.

- 표현 영역과 응용 영역은 도메인 영역을 사용하고, 도메인 영역은 인프라스트럭처 영역을 사용하므로 계층 구조를 적용하기 적당함.

- 도메인의 복잡도에 따라 응용과 도메인을 분리하기도 하고, 한 계층으로 합치기도 한다.
- 계층 구조는 특성상 상위 계층에서 하위 계층으로 의존만 존재하고 하위 계층은 상위 계층에 의존하지 않는다.
  + 계층 구조를 엄격하게 사용하면 바로 아래 계층에만 의존을 가져야 하지만 구현의 편리함을 위해 계층 구조를 유연하게 적용하기도 한다.


## DIP
> 고수준 모듈은 의미 있는 단일 기능을 제공하는 모듈이다. 

- 고수준 모듈의 기능을 구현하려면 여러 하위 기능이 필요하다.
  + 고수준 모듈 `가격 할인 계산`
    * 저수준 모듈, RDMS에서 JPA로 구한다
    * 저수준 모듈, Drools 룰을 적용한다.

- DIP는 이 문제를 해결하기 위해 저수준 모듈이 고수준 모듈에 의존하도록 바꾼다.
- 저수준 모듈에 직접 의존하지 않고 인터페이스를 사용하여 고수준의 모듈끼리 연관관계를 맺는다.


###  DIP 주의사항
> DIP를 잘못 생각하면 단순히 인터페이스와 구현 클래스를 분리하는 정도로 받아들일 수 있다.
- DIP의 핵심은 고수준 모듈이 저수준 모듈에 의존하지 않도록 하기 위함.
- DIP를 적용한 결과 구조만 보고 저수준 모듈에서 인터페이스를 추춣하는 경우가 있다.
  + DIP를 적용할 때 하위 기능을 추상화한  인터페이스는 고수준 모듈 관점에서 도출한다.

### DIP와 아키텍처
> 인트라스트럭처 영역은 구현 기술을 다루는 저수준 모듈이고 응용 영역은 고수준 모듈이다.

- 인프라스트럭처 계층이 가장 하단에 위치하는 계층형 구조와 달리 아키텍처에 DIP를 적용하면 인프라스트럭처 영역이 응용 영역과 도메인 영역에 의존하는 구조가 된다.
  + 인프라스트럭처에 위치한 클래스가 도메인이나 응용 영역에 정의한 인터페이스를 상속받아 구현하는 구조가 되므로 도메인과 응용 영역에 대한 영을 주지 않거나 최소화하면서 변경할 수 있다.  

## 도메인 영역의 주요 구성요소

#### 엔티티
- 고유의 식별자를 갖는 객체로 자신의 라이프 사이클을 갖는다.
- 주문, 회원, 상품과 같은 도메인의 고유한 개념을 갖는다.
- 도메인 모델의 데이터를 포함하며 해당 데이터와 관련된 기능을 함께 제공한다.

#### 밸류
- 고유의 식별자를 갖지 않는 객체로 주로 개념적으로 하나인 값을 표현한다.
- 엔티티의 속성으로 사용할 뿐만 아니라 다른 밸류 타입의 속성으로도 사용할 수 있다.

#### 애그리거트
- 연관된 엔티티와 밸류 객체를 개념적으로 하나로 묶은 것.

#### 리포지터리
- 도메인 모델의 영속성을 처리한다.
- DBMS 테이블에서 엔티티 객체를 로딩하거나 저장하는 기능을 제공한다.

#### 도메인 서비스
- 특정 엔티티에 속하지 않는 도메인 로직을 제공한다.
- `할인 금액 계산`은 상품, 쿠폰, 회원 등급, 구매 금액 등 자용한 조건을 이용해서 구현하게 되는데, 이렇게 도메인 로직이 여러 엔티티와 밸류를 필요로 하면 도메인 서비스에서 로직을 구현한다.

### 엔티티와 밸류
- 도메인 모델의 엔티티와 DB 모델의 엔티티는 다른 것이다. 
- 이 두 모델의 가장 큰 차이점은 도메인 모델의 엔티티는 데이터와 함께 도메인 기능을 함꼐 제공한다는 점이다.


### 애그리거트
> 도메인 모델이 복잡해지면 개발자가 전체 구조가 아닌 한 개 엔티티와 밸류에만 집중하는 상황이 발생한다. 이때 상위 수준에서 모델을 관리하지 않고 개별 요소에만 초점을 맞추다 보면, 큰 수준에서 모델을 이해하지 못해 큰 틀에서 모델을 관리할 수 없는 상황에 빠질 수 있다.

- 애그리거트는 관련 객체를 하나로 묶은 군집이다.
- 주문
  + 주문, 배송지 주문, 주문자, 주문 목록, 총 결제 금액의 하위 모델로 구성된다.
  + 하위 개념을 표현한 모델을 하노로 묶어서 `주문`이라는 상위 개념을 표현할 수 있다.
- 애그리거트를 사용하면 개별 객체가 아닌 관련 객체를 묶어서 객체 군집 단위로 모델을 바라볼 수 있게 된다.

### 리포지터리
> 도메인 객체를 지속적으로 사용하려면 RDBMS, NoSQL 로컬 파일과 같은 물리적인 저장소에 도메인 객체를 보관해야한다. 이를 위한 도메인 모델이 Repository이다.

### 인프라스트럭처
> 표현 영역, 응용 영역, 도메인 영역을 지원한다.

- 도메인 객체의 영속성 처리, 트랜잭션, SMTP 클라이언트, REST 클라이언트 등 다른 영역에서 필요로 하는 프레임워크, 구현 기술, 보조 기능을 지원한다.

- 구현의 편리함은 DIP가 주는 장점(변경의 유연함, 테스트가 쉬움)만큼 중요하기 때문에 DIP의 장점을 해치지 않는 범위에서 응용 영역과 도메인 영역에서 구현 기술에 대한 의존을 가져가는 것이 나쁘지 않다고 생각해야한다.
  + 인프라스트럭처에 대한 의존을 완전히 갖지 않도록 시도하는 것은 자칫 구현을 더 복잡하고 어렵게 만들 수 있다.

## 마무리
> 모듈 구조를 얼마나 세분화해야 하는지에 대해 정해진 규칙은 없다. 한 패키지에 너무 많은 타입이 몰려서 코드를 찾을 떄 불편한 정도만 아니면 된다. 개인적으로 한 패키지에 가능하면 10~15개 미만으로 타입 개수를 유지하려고 노력해야한다.