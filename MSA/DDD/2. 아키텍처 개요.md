## 아키텍처 개요

### 네 개의 영역
> `표현`, `응용`, `도메인`, `인프라스트럭처`는 아키텍처를 설계할 때 출현하는 전형적인 네 가지 영역이다.

- 표현 영역은 응용 영역에 전달하고, 응용 영역의 처리 결과를 다시 사용자에게 보여주는 역할을 한다.
- 웹 애플리케이션의 표현 영역은 HTTP 요청을 응용 영역이 필요로 하는 형식으로 변환해서 응용 영역에 전달하고 응용 영역의 응답을 HTTP 응답으로 변환.
  + HTTP  요청 파라미터로 전송한 데이터를 응용 서비스가 요구하는 형식의 객체 타입으로 변환해서 전달. 
  + 응용 서비스가 리턴한 결과를 JSON 형식으로 변환해서 HTTP 응답으로 웹 브라우저에 전송.
- 표현 영역을 통해 사용자의 요청을 전달받는 `응용 영역`은 시스템이 사용자에게 제공해야 할 기능을 구현.'
- `응용 서비스`는 로직을 직접 수행하기보다는 도메인 모델에 로직 수행을 위임한다.
- `인프라스트럭처 영역`은 구현 기술에 대한 것을 다루낟.
  + RDMS 연동을 처리하고, 메시징 큐에 메시지를 이용
- 도메인 영역, 응용 영역, 표현 영역은 구현 기술을 사요한 코드를 직접 만들지 않는다.
- 대신 `인프라트럭처 영역`에서 제공하는 기능을 사용해서 필요한 기능을 개발한다.

### 계층 구조 아키텍처
> 표현 영역과 응용 영역은 도메인 영역을 사용하고, 도메인 영역은 인프라스트럭처 영역을 사용하므로 계층 구조를 적용하기에 적당해 보인다.
- 계층 구조는 그 특성상 상위 계층에서 하위 계층으로의 의존만 존재하고 하위 계층은 사우이 계층에 의존하지 않는다.
- 표현 계층은 응용 계층에 의존하고 응용 계층이 도메인 계층에 의존하지만, 반대로 인프라스트럭처 계층이 도메인에 의존하거나 도메인이 응용 계층에 의존하지는 않는다.
- 계층 구조를 엄격하게 적용한다면 상위 계층은 바로 아래의 계층에만 의존을 가져야 하지만 구현의 편리함을 위해 계층 구조를 유연하게 적용하기도 한다.
  + 응용 계층은 바로 아래 계층인 도메인 계층에 의존하지만 외부 시스템과의 연동을 위해 더 아래 계층인 인프라 스트럭처 계층에 의존하기도 한다.

### DIP
> 저수준 모듈이 고수준 모듈에 의존하도록 변경하는 것.
- 추상화 인터페이스를 통해 구현할 수 있다.
- 인터페이스는 상위 계층에 존재해야한다.,

### 도메인 영역의 주요 구성요소
- 엔티티
  + 고유 식별자를 갖는 객체로 자신의 라이프 사이클을 갖는다.
  + 주문, 회원, 상품과 같이 고유한 개념을 표현한다.

- 밸류
  + 고유의 식별자를 갖지 않는 객체로 주로 개념적으로 하나인 값을 표현할 때 사용된다.
  + 배송지 주소를 표현하기 위한 Adress나 구매 금액을 위한 Money와 같은 타입이 밸류 타입.
  + 엔티티의 속성으로 사용할 뿐만 아니라 다른 밸류 타입의 속성으로도 사용할 수 있다.

- 애그리거트
  + 애그리거트는 연관된 다른 엔티티와 밸류 객체를 개념적으로 하나로 묶은 것이다.
  + Order -> 엔티티, OrderLine -> 밸류, Orderer 밸류를 묶어 `주문`애그리거트로 묶을 수 있다.

- 리포지터리
  + 도메인 모델의 영속성을 처리한다.
  + DBMS 테이블에서 엔티티 객체를 로딩하거나 저장하는 기능을 제공한다.

- 도메인 서비스
  + 특정 엔티티에 속하지 않는 도메인 로직을 제공한다.
  + `할인 금액 계산`은 상품, 쿠폰, 회원 등급, 구매 금액 등 다양한 조건을 이용해서 구현하게 되는데, 이렇게 도메인 로직이 여러 엔티티와 밸류를 필요로 하면 도메인 서비스에서 로직을 구현한다.

#### 엔티티와 밸류
> 필자는 개발 초년 시절 도메인 모델을 만들 때 DB 테이블의 엔티티와 도메인 모델의 엔티티를 구분하지 못해 동일하게 만들곤 했다. 하지만 실제론 도메인 모델의 엔티티와 DB 관계형 모델의 엔티티는 다른 것이였다.

- 이 두 모델의 가장 큰 차이점은 도메인 모델의 엔티티는 데이터와 함꼐 도메인 기능을 함께 제공한다는 점이다.
- 도메인 모델의 엔티티는 단순히 데이터를 담고 있는 데이터 구조라기보다는 데이터와 함꼐 기능을 제공하는 객체이다.
- 도메인 관점에서 기능을 구현하고 기능 구현을 캡슐화해서 데이터가 임의로 변경되는 것을 막는다.
- 도메인 모델의 엔티티는 두 개 이상의 데이터가 개념적으로 하나인 경우 밸류 타입을 이용해서 표현할 수 있다는 점.

#### 애그리거트
> 도메인이 커질수록 개발할 도메인 모델도 커지면서 많은 엔티티와 밸류가 출현한다. 엔티티와 밸류 개수가 많아질수록 모델은 점점 더 복잡해진다.

- 도메인 모델이 복잡해지면 개발자가 전체 구조가 아닌 한 개 엔티티와 밸류에만 집중하는 상황이 발생한다.
- 상위 수준에서 모델을 관리하지 않고 개별 요소에만 초점을 맞추다 보면, 큰 수준에서 모델을 이해하지 못해 큰 틀에서 모델을 관리할 수 없는 상황에 빠진다.
- `애그리거트`는 관련 객체를 하나로 묶은 군집이다.
  + `주문`, `배송지 정보`, `주문자`, `주문 목록`, `총 결제 금액`의 하위 모델로 구성된다.
  + 이 하위 개념을 표현한 모델을 하나로 묶어서 `주문`이라는 상위 개념으로 표현할 수 있다.

#### 리포지터리
- 리포지터리는 애그리거트 단위로 도메인 객체를 저장하고 조회하는 기능을 정의한다.
- 도메인 모델을 사용해야 하는 코드는 리포지터리를 통해서 도메인 객체를 구한 뒤에 도메인 객체의 기능을 실행한다.
- 도메인 모델 관점에서 OrderRepository는 도메인 객체를 영속화하는 데 필요한 기능을 추상화한 것으로 고수준 모듈에 속한다.
- 응용 서비스와 리포지터리는 밀접한 연관이 있다.
  + 응용 서비스는 필요한 도메인 객체를 구하거나 저장할 때 리포지터리를 사용한다.
  + 응용 서비스는 트랜잭션을 관리하는데, 트랜잭션 처리는 리포지터리 구현 기술의 영향을 받는다.
- 리포지터리를 사용하는 주체가 응용 서비스이기 때문에 리포지터리는 응용 서비스가 필요로하는 메서드를 제공한다.
  + 애그리거트를 저장하는 메서드
  + 애그리거트 루트 식별자로 애그리거트를 조회하는 메서드

#### 인프라스트럭처
`표현 영역`, `응용 영역`, `도메인 영역`을 지원한다.
- 도메인 객체의 영속성 처리, 트랜잭션, SMTP 클라이언트 등 다른 영역에서 필요로 하는 프레임워크, 구현 기술, 보조 기능을 지원한다.
- DIP에서 언급한 것처럼 도메인 영역과 응용 영역에서 인프라스트럭처의 기능을 직접 사용하는 것보다 이 두 영역에 정의한 인터페이스를 
- 인프라스트럭처 영역에서 구현하는 것이 시스템을 더 유연하고 테스트하기 쉽게 만들어준다.

#### 모듈 구성
> 도메인 모듈은 도메인에 속한 애그리거트를 기준으로 다시 패키지를 구성한다.
- 모듈 구조를 얼마나 세분화해야 하는지에 대해 정해진 규칙은 없다.
- 한 패키지에 너무 많은 타입이 몰려서 코드를 찾을 때 불편한 정도만 아니면 된다.
- 한 패키지에 가능하면 10~15개 미만으로 타입 개수를 유지하면된다.