# 서버리스 API 구성

> Amazon API Gateway는 규모와 관계없이 REST 및 WebSocket API를 생성, 게시, 유지 모니터링 및 보호하기 위한 AWS 서비스.

- AWS 클라우드에 저장된 데이터에 액세스하는 API를 생성할 수 있다.

- 아래와 같은 RESTful API를 생성
  + HTTP 기반
  + 상태 비저장 클라이언트-서버 통신
  + 표준 HTTP 메서드를 구현
- 
- 아래와 같은 WebSocket API를 생성
  + 클라이언트와 서버 간에 상태를 저장하는 전이중 통신을 지원하는 WebSocket 프로토콜 준수
  + 수신 메시지를 메시지 콘텐츠에 따라 라우팅

- API 게이트웨이는 트래픽 관리, 권한 부여 및 액세스 제어, 모니터링, API 버전 관리를 지원한다.

## 서버리스 인프라

- 가상 서버인 EC2를 사용하지 않고 웹 시스템을 구축할 수 있다.
  + 따로 서버 관리가 필요없으며, 애플리케이션 개발에 집중할 수 있다.
  + AWS 람다 + API 게이트웨이 서비스를 통해 서버리스로 구현이 가능.

### 서버리스 포털 사이트 구축하기

- AWS 람다, 아마존 API 게이트웨이, 아마존 클라우드프론트, 아마존 S3를 사용하여 구현
- 각 관리형 서비스 뒤에서 서버가 존재하지만 해당 서버는 AWS사에서 담당하게 된다.
- 서포트 페이지의 동적 컨텐츠 관련 처리는 AWS 람다와 아마존 API 게이트웨이를 사용.
  + 람다는 이벤트 발생에 따라 임의의 프로그램을 실행하는 관리형 서비스로
  + API 게이트 웨이는 AWS 환경에서 REST API를 정의하여 요청을 받아 처리하는 관리형 서비스.
- 람다와 아마존 API로는 데이터를 유지할 수 없으므로 RDS에 데이터를 저장
- 정적 컨텐츠는 아마존 클라우드프론트와 아마존 S3를 이용하여 전달
  + 해당 방법을 활용하면 EC2를 이용해 웹 서버를 구축할 필요가 없기 때문에 설계 및 유지 보수에, 운영 시간이 절약
- AMI를 사용하여 설계, 테스트를 진행
  + AMI는 미들웨어와 애플리케이션이 설치된 OS 이미지로, AWS와 사용자 커뮤니티, 소프트웨어 공급 업체를 통해서 제공

### 웹 서비스 만들기
- 사용자는 인터넷을 통해 API 게이트웨이에서 정의하는 리소스에 접속.
  + 리소스는 API로 작업할 대상정보.
- API 게이트웨이는 요청을 받아 백엔드 서비스를 호출하는 이외에도 인증 캐시, 세션 상태 관리, API 실행 상태 모니터링 및 로깅 기능을 갖고 있습니다.
- 요청이 많아지면 자동으로 확장하거나 초당 메서드 호출 횟수에 제한을 걸 수도 있습니다.
  + 관리용 대시보드에서는 API 호출 횟수, 대기시간, 에러율 등을 확인할 수 있습니다.
- API 게이트웨이를 사용하는 경우 상태 저장형 API가 아닌 상태 비저장형 API로서 설계해야한다.
  + 전후처리가 서로 독립적인 관계를 유지해야하며, 처리에 필요한 모든 정보를 가지도록 한다.
- 유닛 테스트 후에 매니지먼트 콘솔의 람다 화면에서 람다 함수로서 업로드.

#### 람다 함수 사용 시 유의사항
- 단시간에 끝나는 가벼운 작업을 많이 수행하는 경우를 가정한 것으로, 오랜 시간이 걸리는 무거운 처리에는 적합하지 않습니다.
- 전후 작업과 독립적으로 처리해야하므로 종속성이 강한 경우에도 적합하지 않습니다.
- 실행 시간이 길거나 상태 저장작업을 수행하려면 EC2 인스턴스에 서버를 구축.
- 빠른 응답 속도가 요구되는 용도에도 적합하지 않다.
  + 컨테이너에서 매번 시작, 종료하기 때문에 프로세스가 대기하는 웹 서버와 비교하면 시작 및 종료 할 때마다 매번 데이터베이스에 연결해야 하기때문에 오버헤드가 발생한다.
- 설정시 제한시간에 주의
  + 기본값은 3초로 1초에서 900초 까지 지정할 수 있다.
- 람다 함수 단독으로 사용할 수 없는 이유는 API 게이트웨이가 HTTP 메소드에서 받은 매개변수를 JSON으로 변환하여 람다 함수에 전달.

### 요금 체계
- API 게이트웨이와 람다 요금 체계는 요청 횟수와 처리 시간에 따라 달라짐.
- 시스템의 기능을 간단한 API로 정의하면, EC2를 사용하는 것보다 훨씬 저렴한 요금이 나옴.

## WebSocket API

- API Gateway에서 AWS 서비스 또는 HTTP 엔드포인트에 대한 상태 저장 프론트엔드로 WebSocket PAI를 만들 수 있다.
- REST API와 달리 WebSocket API는 클라이언트 앱과 백엔드 간의 양방향 통신을 지원한다.
  + 백엔드는 연결된 클라이언트로 콜백 메시지를 보낼 수 있다.
- `routeSelectionExpression`은 API 수준에서 정의되는 속성이다.
- `$connect`, `$disconnect`, `default` 등 세 가지 사전 정의된 라우팅을 사용할 수 있다.
  + `$connect` 지속적인 연결이 시작 될 때 라우팅을 호출합니다.
  + `$disconnect` 클라이언트 또는 서버가 API와의 연결을 끊을 때 호출합니다.
  + `$default` 일치하는 라우팅이 없거나 메시지를 기준으로 라우팅 선택 표현식을 평가할 수 없는 경우 API Gateway가 호출.
