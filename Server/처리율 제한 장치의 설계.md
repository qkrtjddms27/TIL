# 처리율 제한 장치의 설계
> 네트워크 시스템에서 처리율 제한 장치는 클라이언트 또는 서비스가 보내는 트래픽의 처리율을 제어하기 위한 장치다.

## 예시
- 사용자는 초당 2회 이상 새 글을 올릴 수 없다.
- 같은 IP 주소로는 하루에 10개 이상의 계정의 생성할 수 없다.
- 같은 디바이스로는 주당 5회 이상 리워드를 요청할 수 없다.

## 처리율 제한 장치를 두는 이유
- DoS(Denial of Service) 공격에 의한 자원 고갈을 방지 할 수 있다.
  + 트위터는 3시간 동안 300개의 트윗만 올리 수 있다.
  + 구글 독스 API는 사용자당 분당 300회의 read 요청만 허용한다.

- 비용 절감
  + 처리율 제한은 제3자 API에 사용료를 지불하고 있는 회사들에게는 아주 중요하다.
  + 추가 요청에 대한 처리를 제한하며 서버를 많이 두지 않아도 된다.

- 서버 과부화를 막는다.
  + 봇에서 오는 트래픽이나 사용자의 잘못된 이용 패턴으로 유발된 트래픽을 막는다.
    
## 1단계, 문제 이해 및 설계 범위 확정
> 처리율 제한 장치를 구현하는 데는 여러 가지 알고리즘을 사용할 수 있는데, 그 각각의 고유한 장단점을 갖고 있다.

- 어떤 종류의 처리율 제한 장치를 설계해야 하나요? 클라이언트 측? 서버 측?
  + 서버 측 제한 장치
- 어떤 기준으로 API 호출을 제어해야 하나요? IP 주소를 사용해야하나요? 아니면 사용자 ID? 아니면 다른 어떤 기준이 있습니까?
  + 다양한 형태의 제어 규칙을 정의할 수 있도록 하는 유연한 시스템.
- 시스템 규모는 어느 정도여야 할까요? 스타트업 정도 회사? 사용자가 많은 큰 기업?
  + 대규모 요청을 처리할 수 있어야 하는 규모
- 시스템이 분산 환경에서 동작해야 하나요?
  + 네
- 처리율 제한 장치는 독립된 서비스입니까 아니면 애플리케이션 코드에 포함될 수도 있습니까?
  + 본인 역략에 따라서
- 사용자의 요청이 처리율 제한 장치에 의해 걸러진 경우 사용자에게 그 사실을 알려야 하나요?
  + 그렇습니다.
    
### 요구사항 요약
- 설정된 처리율을 초과하는 요청은 정확하게 제한한다.
- 낮은 응답시간, 이 처리율 제한 장치는 HTTP 응답시간에 나쁜 영향을 주어서는 곤란하다.
- 가능한 한 적은 메모리를 사용해야 한다
- 분산형 처리율 제한, 하나의 처리율 제한 장치를 여러 서버나 프로세스에서 공유할 수 있어야 한다.
- 예외 처리, 요청이 제한되었을 때는 그 사실을 사용자에게 분명하게 보여주어야 한다.
- 높은 결함 감내성, 제한 장치에 장애가 생기더라도 전체 시스템에 영향을 주어서는 안 된다.

## 2단계, 개략적 설계안 제시 및 동의 구하기
> 기본적인 클라리언트-서버 통신 모델을 사용.

### 처리율 제한 장치는 어디에 둘 것인가?
- 클라이언트 측에 둘 수도 있고, 서버 측에 둘 수도 있다.
- 클라이언트 : 일반적으로 처리율 제한을 안정적으로 걸 수 있는 장소가 되긴 힘들다. 쉽게 위변조 가능
- 서버 : 서버 측에 제한 장치를 두거나 미들웨어로 하여금 API 서버로 가는 요청을 통제하도록 한다.
  + 마이크로서비스의 경우 처리율 제한 장치는 API 게이트웨이라 불리는 컴포넌트에 구현된다.
  + API 게이트웨이는 처리율 제한, SSL 종단, 사용자 인증, IP 허용목록 관리 등을 지원하는 완전 위탁관리형 서비스
  
### 처리율 제한 알고리즘
- 토큰 버킷
- 누출 버킷
- 고정 윈도 카운터
- 이동 윈도 로그
- 이동 윈도 카운터

#### 토큰 버킷 알고리즘
> 토큰 버킷 알고리즘은 처리율 제한에 폭넓게 이용되고 있다. 간단하고, 알고리즘에 대한 세간의 이해도도 높은 편이며 기업들이 보편적으로 사용하고 있다.

- 토큰 버킷은 지정된 용량을 갖는 컨테이너. 
  

- 이 버킷에는 사전 설정된 양의 토큰이 채워진다.
  + 토큰이 꽉찬 버킷은 초과로 채워지지 않는다.


- 요청이 처리될 때마다 하나의 토큰을 사용한다.
  + 토큰이 존재하면 버킷에서 토큰 하나를 꺼낸 후 요청을 시스템에 전달한다
  + 충분한 토큰이 없는 경우, 해당 요청은 버려진다.


- 토큰 버킷의 2개 인자
  + 버킷 크기 : 버킷에 담을 수 있는 토큰의 최대 갯수
  + 토큰 공급률 : 초당 몇 개의 토큰이 버킷에 공급되는가


- 예시
  + API 엔드 포인트마다 별도의 버킷을 둔다. 아래의 경우 사용자 마다 3개의 버킷을 가짐.
    * 사용자 마다 하루에 한 번만 포스팅
    * 친구는 150명까지 추가 가능
    * 좋아요 버튼은 다섯 번까지
  + IP 주소별로 처리율 제한을 적용해야 한다면 IP 주소마다 버킷을 하나씩 할당
  + 시스템의 처리율을 초당 10,000개의 요청으로 제한하고 싶다면, 모든 요청이 하나의 버킷을 공유하도록 해야함.


- 정리
  + 구현이 쉽고, 메모리 사용 측면에서도 효율적이다.
  + 짧은 시간에 집중되는 트래픽도 처리 가능하다.
  + 이 알고리즘은 버킷 크기와 토큰 공급률이라는 두 개 인자를 가지고 있는데, 이 값을 적절하게 튜닝하는 것은 까다롭다.
    

#### 누출 버킷 알고리즘
> 토큰 버킷 알고리즘과 비슷하지만 요청 처리율이 고정되어 있다는 점이 다르다. 

- 누출 버킷 알고리즘은 보통 FIFO 큐로 구현한다.


- 순서
  + 요청이 도착하면 큐가 가득 차 있는지 본다. 빈자리가 있는 경우에는 큐에 요청을 추가한다.
  + 큐가 가득 차 있는 경우에는 새 요청은 버린다.
  + 지정된 시간마다 큥에서 요청을 꺼내어 처리한다.
    

- 누출 버킷 알고리즘의 2개의 인자
  + 버킷 크기 : 큐 사이즈와 같은 값
  + 처리율 : 지정된 시간당 몇 개의 항목을 처리할지 지정하는 값.
    
