# 알림 시스테 설계
> 알림 시스템은 단수히 모바일 푸시 알림에 한정되지 않는다. 사실 알림 시스템은 모바일 푸시 알림, SMS 메시지, 그리고 이메일로 세 가지로 분류할 수 있다.

## 1단계, 문제 이해 및 설계 범위 확정
> 하루에 백만 건 이상의 알림을 처리하는 확장성 높은 시스템을 구착하는 게 쉬운 과제는 아니다. 일림 시스템이 어떻게 구현되는지에 대한 깊은 이해가 필요한 작업이다.

- 이 시스템은 어떤 종류의 알림을 지원해야 하나요?
  + 푸시 알림, SMS 메시지, 그리고 이메일입니다.

- 실시간 시스템이어야 하나요?
  + 연성 실시간 시스템이라고 가정합니다. 최대한 빠르게 전달되어야 하지만 높은 부하가 걸렸을 때 약간의 지연은 무방합니다.

- 어떤 종류의 단말을 지원해야 하나요?
  + IOS 단말, 안드로이드 단말, 그리고 랩탑 데스크톱을 지원해야 합니다.

- 사용자에게 보낼 알림은 누가 만들 수 있나요?
  + 클라이언트 애플리케이션 프로그램이 만들 수도 있고, 서버 측에서 스케줄링 할 수도 있습니다.

- 사용자가 알림을 받지 않도록 설정할 수도 있어야 하나요?
  + 네, 해당 설정을 마친 사용자는 더 이상 알림을 받지 않습니다.

- 하루에 몇 건의 알림을 보낼 수 있어야 하나요?
  + 천만 건의 모바일 푸시 알림, 백만 건의 SMS 메시지, 5백만 건의 이메일을 보낼 수 있어야 합니다.

## 2단계, 개략적 설계안 제시 및 동의 구하기

- 알림 유형별 지원 방안
- 연락처 정보 수집 절차
- 알림 전송 및 수신 절차

### 알림 유형별 지원 방안

#### ios 푸시 알림
> iOS에서 푸시 알림을 보내기 위해서는 세 가지 컴포넌트가 필요하다.

- 알림 제공자 : 알림 요청을 만들어 애플 푸시 알림 서비스로 보내주는 주체.
  + 단말 토큰 : 알림 요청을 보내는 데 필요한 고유 식별자
  + 페이로드 : 알림 내용을 담은 JSON 딕셔너리.
  ```
  {
    "aps" : {
      "alert" : {
        "title" : "Game Request",
        "body" : "Bob wants to play chess",
        "action-loc-key" : "PLAY"
      },
      "badge" : 5
    }
  }
  ```

- APNS : 애플이 제공하는 원격 서비스다. 푸시 알림을 IOS 장치로 보내는 역할을 담당한다.

- iOS 단말 : 푸시 알림을 수신하는 사용자 단말이다.

#### 안드로이드 푸시 알림
> 안드로이드 푸시 알림도 iOS 푸시 알림과 비슷한 절차로 전송된다. APNS 대신 FCM을 사용한다는 점만 다르다.

#### SMS 메시지
> SMS 메시지를 보낼 때는 보통 트윌리오, 넥스 같은 제3사업자의 서비스를 많이 이용한다. 이런 서비스는 대부분 사용 서비스라서 이용요금을 내야 한다.

#### 이메일
> 상용 이메일 서비스를 이용한다. 그중 유명한 서비스로 센드그리드, 메일침프가 있다. 전송 성공률도 높고, 데이터 분석 서비스도 제공한다.

### 연락처 정보 수집 절차
> 알림을 보내려면 모바일 단말 토큰, 전화번호, 이메일 주소 드으이 정보가 필요하다. 처음으로 계정을 등록하면 API 서버는 해당 사용자의 정보를 수집하여 데이터베이스에 저장한다.

### 알림 전송 및 수신 절차 (개략적 설계안, 초안)

#### 1부터 N까지 서비스
> 이 서비스 각각의 마이크로서비스일수도 있고, 크론잡일 수도 있고, 분산 시스템 컴포넌트일 수도 있다. 사용자에게 납기일을 알리고자 하는 과금 서비스, 배송아림을 보내려는 쇼핑몰 웹사이트 등이 그 예시이다.

#### 알림 시스템
> 알림 시스템은 알림 전송/수신 처리의 핵심이다. 우선은 1개 서버만 사용하는 시스템이라고 가정해 보자. 이 시스템은 서비스 1~N에 알림 전송을 위한 API를 제공해야 하고, 제 3자 서비스에 전달할 알림 페이로드를 만들어 낼 수 있어야 한다.

#### 제3자 서비스
> 이 서비스들은 사용자에게 알림을 실제로 전달하는 역할을 한다. 제3자 서비스와의 통합을 진행할 때 유의할 것은 확장성이다. 쉽게 새로운 서비스를 통합하거나 기존 서비스를 제거할 수 있어야 한다는 뜻이다. 가령 FCM은 중국에서는 사용할 수 없다.

#### iOS, 안드로이드, SMS, 이메일 단말
> 사용자는 자기 단말에서 알림을 수신한다.


#### 해당 설계의 문제점
- SPOF : 알림 서비스에 서버가 하나밖에 없다는 것은, 그 서버에 장애가 생기면 전체 서비스의 장애로 이어진다는 뜻

- 규모 확장성: 한 대 서비스로 푸시 알림에 관계된 모든 것을 처리하므로, 데이터베이스나 캐시 등 중요 컴포넌트의 규모를 개별적으로 늘릴 방법이 없다.

- 성능 병목: 알림을 처리하고 보내는 것은 자원을 많이 필요로 하는 작업일 수 있다. 예를 들어 HTML 페이지를 만들고 제3자 서비스의 응답을 기다리는 일은 시간이 많이 걸릴 가능성이 있는 작업이다. 따라서 모든 것을 한 서버로 처리하면 사용자 트래픽이 많이 몰리는 시간에는 시스템이 과부하 상태에 빠질 수 있다.

### 알림 전송 및 수신 절차 (개략적 설계안, 개선된 버전)

- API를 호출하여 알림 서버로 알림을 보낸다.
- 알림 서버는 사용자 정보, 단말 토큰, 알림 설정 같은 메타데이터를 캐시나 데이터베이스에서 가져온다.
- 알림 서버는 전송할 알림에 맞는 이벤트를 만들어서 해당 이벤트를 위한 큐를 넣는다.
- 작업 서버는 메시지 큐에서 알림 이벤트를 꺼낸다.
- 작업 서버는 알림을 제3자 서비스로 보낸다.
- 제3자 서비스는 사용자 단말로 알림을 보낸다.

#### 목적

- 데이터베이스와 캐시를 알림 시스템의 주 서버에 분리한다.
- 알림 서버를 증설하고 자동으로 수평적 규모 확장이 이루어질 수 있도록한다.
- 메시지 큐를 이용해 시스템 컴포넌트 사이의 강한 결합을 끊는다.

#### 1부터 N까지의 서비스
> 알림 시스템 서버의 API를 통해 알림을 보낼 서비스들

#### 알림 서버

- 알림 전송 API: 스팸 방지를 위해 보통 사내 서비스 또는 인증된 클라이언트만 이용 가능하다.

- 알림 검증 : 이메일 주소, 전화번호 등에 대한 기본적 검증을 수행한다.

- 데이터베이스 또는 캐시 질의 : 알림에 포함시킬 데이터를 가져오는 기능이다.

- 알림 전송: 알림 데이터를 메시지 큐에 넣는다. 본 설계안의 경우 하나 이상의 메시지 큐를 사용하므로 알림을 병렬적으로 처리할 수 있다.

#### 캐시 
> 사용자 정보, 단말 정보, 알림 템플릿 등을 캐시한다.

#### 데이터베이스
> 사용자, 알림, 설정 등 다양한 정보를 저장한다.

#### 메시지 큐 
> 시스템 컴포넌트 간 의존성을 제거하기 위해 사용한다. 다량의 알림이 전송되어야 하는 경우를 대비한 버퍼 역할도 한다.

#### 작업 서버
> 메시지 큐에 전송할 알림을 꺼내서 제3자 서비스로 전달하는 역할을 담당한다.

#### iOS, 안드로이드, SMS, 이메일 단말

## 3단계, 상세 설계

> 안정성, 추가로 필요한 컴포넌트 및 고려사항, 개선된 설계안에 대해 자세히 알아볼 것이다.

### 안정성

> 분산 환경에서 운영될 알림 시스템을 설계할 때는 안정성을 확보하기 위한 사항 몇 가지를 반드시 고려해야 한다.

#### 데이터 손실 방지

- 어떤 상황에서도 알림이 소실되면 안 된다.
  + 알림이 지연되거나 순서가 틀려도 괜찮지만, 사라지면 안된다.

- 알림 데이터를 데이터베이스에 보관하고 재시도 메커니즘을 구현해야 한다.

#### 알림 중복 전송 방지
> 같은 알림이 여러 번 반복되는 것을 막는 것은 가능하지 않다. 대부분의 경우 알림은 딱 한 번만 전송되겠지만, 분산 시스템의 특성상 가끔은 같은 알림이 중복되어 전송되기도 할 것이다.

- 보내야 할 알림이 도착하면 그 이벤트 ID를 검사하여 이전에 본 적이 있는 이벤트인지 살핀다.

### 추가로 필요한 컴포넌트 및 고려사항

> 알림 템플릿, 알림 설정, 이벤트 추적, 시스템 모니터링, 처리율 제한 등 알림 시스템 구현을 위해 필요한 추가 컴포넌트들에 대해 알아보자.

#### 알림 템플릿
> 알림 템플릿은 유사성을 고려하여, 알림 메시지의 모든 부분을 처음부터 다시 만들 필요 없도록 해준다. 알림 템플릿은 인자나 스타일, 추적 링크를 조정하기만 하면 사전에 지정한 형식에 맞춰 알람을 만들어 내는 틀이다.

#### 알림 설정
> 너무 많은 알림을 받고 있는 다면 쉽게 피곤함을 느낀다. 웹사이트와 앱에서 사용자가 알림 설정을 상세히 조정할 수 있도록 하고 있다. 

#### 전송률 제한
> 사용자에게 너무 많은 알림을 보내지 않도록 하는 한 가지 방법은 한 사용자가 받을 수 있는 알림의 빈도를 제한하는 것이다.

#### 재시도 방법
> 제3자 서비스가 알림 전송에 실패하면, 해당 아림을 재시도 전용 큐에 넣는다. 같은 문제가 계속해서 발생하면 개발자에게 통지한다.

#### 푸시 알림과 보안
> iOS와 안드로이드 앱의 경우, 알림 전송 API는 appKey와 appSecret을 사용하여 보안을 유지한다.

- 인증된, 승인된 클라이언트만 해당 API를 사용하여 알림을 보낼 수 있다.

#### 큐 모니터링
> 알림 시스템을 모니터링 할 때 중요한 메트릭 하나는 큐에 쌓인 알림의 개수이다.

#### 이벤트 추적
> 알림 확인율, 클릭율, 실제 앱 사용으로 이어지는 비율 같은 메트릭은 사용자를 이해하는데 중요하다. 데이터 분석 서비스는 보통 이벤트, 추적 기능도 제공한다.

## 4단계, 마무리
> 알림은 중요 정보를 계속 알려준다는 점에서 필요불가결한 기능이다. 넷플릭스 신작 영화 출시 정보, 신규 상품에 대한 할인 쿠폰 이메일, 온라인 쇼핑 결제 확정 메시지 같은 것이 전부 이 알림 기능을 통해 제공되는 것들이다.

- 안정성
  + 메시지 전송 실패율을 낮추기 위해 안정적인 재시도 메커니즘을 도입한다.
  + 보안 : 인증된 클라이언트만이 알림을 보낼 수 있도록 appKey, appSecret 등의 메커니즘을 제공
  + 이벤트 추적 및 모니터링 : 알림이 만들어진 후 성공적으로 전송되기까지의 과정을 추적하고 시스템 상테를 모니터링하기 위해 알림 전송의 각 단계마다 이벤트를 추적하고 모니터링할 수 있는 시스템을 통합하였다.
  + 사용자 설정: 사용자가 알림 설정을 조정할 수 있도록 하여야한다.
  + 사용률 제한: 사용자에게 알림을 보내는 빈도를 제한할 수 있도록 하였다.