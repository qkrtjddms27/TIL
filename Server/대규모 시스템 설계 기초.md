# 대규모 시스템 설계 기초.
> 한 명의 사용자를 지원하는 시스템에서 시작하여, 최종적으로 몇백만 사용자를 지원하는 시스템을 설계.
- 규모 확장성과 관계된 설계 문제를 푸는 데 쓰일 유용한 지식들을 접할 수 있다.

## 단일 서버
- 웹 앱, 데이터베이스, 캐시 등이 전부 서버 한 대에서 실행.

### 실행 흐름
- 사용자 단말(웹, 앱)에서 요청.
- DNS에 URL을 IP주소로 변환 요청
  + DNS서버는 제3 사업자가 제공하는 유료 서비스를 이용하게 된다.
- IP주소로 해당 서버에 HTTP 요청

---

## 데이터베이스, DB
- 사용자가 늘면 서버 하나로는 충분하지 않다.
- DB 서버를 추가하여 웹/모바일 트래팩 처리 용도와 DB를 나눈다.
  + 웹/모바일 트랙픽 처리 용도(웹 계층)와 데이터베이스 서버(데이터 계층)으로 분리.
- 이렇게 추가로 한 단계 더 분리하게 되면 필요에 따라 웹 계층과 데이터 계층을 따로 확장할 수 있다.

### 데이터베이스 선택하기
- DB는 관계형 데이터베이스와 비-관계형 데이터베이스로 나눌 수 있다.
  + 관계형 DB, 자료를 테이블과 열, 칼럼으로 표현한다. JOIN을 지원.
  + 비-관계형 DB, 키-값 저장소, 그래프 저장소, 칼럼 저장소, 문서 저장소가 있다. 일반적으로 JOIN을 지원하지 않는다.

#### NoSQL을 선택하면 좋은 상황
- 아주 낮은 응답 지연시간이 필요.
- 다루는 데이터가 비정형데이터.
- 데이터를 직렬화하거나 역지렬화 할 수 있기만 하면 됨.
- 아주 많은 양의 데이터를 저장할 필요가 있음.

---

## 수직적, 수평적 규모 확장.
- 스케일 업, 수직적 규모 확장, 서버에 고사양 자원을 추가하는 행위.
  + 장점, 서버에 유입되는 트래픽 양이 적을 때 좋은 선택
  + 단점, 한 대의 서버에 CPU나 메모리를 무한대로 증설할 방법은 없다.
  + 단점, 자동복구 방안이나 다중화 방안을 제시하지 않는다.
    * 서버에 장애가 발생하면 웹사이트/앱의 모든 기능은 완전히 중단된다.
  
- 대규모 애플리케이션을 지원하는 데는 수평적 규모 확장법이 더 적절하다.
  + 로드밸런서와 부하 분산기 도입.
  
### 로드밸런서
- 부하 분산 집합에 속한 웹 서버들에게 트래픽 부하를 고르게 분산하는 역할을 한다.
- 자동복구하지 못하는 문제 해소와 가용성 향상.

#### 로드밸런서가 추가된 서버 실행 흐름
- 공개 IP로 로드밸런서로 요청
  + 웹 서버는 클라이언트의 접속을 직접 처리하지 않고 로드밸런서에 위임
- 사설 IP를 통해 다른 서버에 요청을 위임
  + 사설 IP, 같은 네트워크에 속한 서버 사이의 통신에만 사용할 수 있는 IP주소.
  
### 데이터베이스 다중화
- 많은 데이터베이스 관리 시스템이 다중화를 지원한다. 
- 서버 사이에 주-부 관계를 설정하고 데이터 원본은 주 서버에, 사본은 부 서버에 저장하는 방식이다.
  + 쓰기 연산은 주(master) 데이터베이스에서만 가능. 
  + 부(slave) 데이터베이스는 주 데이터베이스로부터 그 사본을 전달바으며, 읽기 연산만을 지원.
- 주로 읽기 연산은 부, 쓰기 연산은 주에서 처리된다
  + 주 데이터베이스 장애 발생시 부 데이터베이스가 맡아서 처리할 수 있다.
  + 부 데이터베이스 장애 발생시 주 데이터베이스가 맡아서 치리할 수 있다.

## 캐시
- 캐시는 값비싼 연산 결과 또는 자주 참조되는 데이터를 메모리 안에 두고, 같은 요청이 빨리 처리될 수 있도록 하는 저장소.
- 애플리케이션의 성능은 데이터 베이스를 얼마나 자주 호출하느냐에 크게 좌우되는데, 캐시는 그런 문제를 보완할 수 있다.

### 캐시 계층
- 데이터가 잠시 보관되는 곳으로 데이터베이스보다 훨씬 빠르다.
- 별도의 캐시 계층을 두면 캐시 계층의 규모를 독립적으로 확장시키는 것도 가능하다.

### 캐시를 이용한 실행 흐름
- 요청을 받은 웹 서버는 캐시에 응답이 저장되어 있는지 확인한다.
- 저장되어 있다면 해당 데이터를 클라이언트에 반환한다. 없는 경우 데이터베이스 질의를 통해 데이터를 찾아 캐시에 저장한 뒤 클라이언트에 반환.

### 캐시 사용 시 유의할 점
- 데이터 갱신은 자주 일어나지 않지만 참조는 빈번하게 일어난다면 고려해볼 만하다.
- 영속적으로 보관할 데이터를 캐시에 두는 것은 바람직하지않다.
- 데이터의 적절한 만료기간을 설정하는 것이 중요하다.
- 영속적인 데이터가 들어있는 저장소와 캐시의 일관성이 유지하는 것은 중요하고 어렵다.
  + 페이스북 논문 참조?? Todo
- 캐시 서버도 다른 서버들과 마찬가지로 단일 장애 지점문제를 피하기위해 여러 지역에 서버를 분산시켜야 한다.
- 캐시 메모리가 너무 작으면 액세스 패턴에 따라서 데이터가 너무 자주 삭제되어 성능상 이점이 많이 떨어질 수 있으므로 과할당하는 것이 좋다.
- 적절한 데이터 방출 정책을 사용하는 것이 좋다. LRU. LFU. FIFO

---

## CDN
- 정적 콘텐츠를 전송하는 데 쓰이는, 지리적으로 분산된 서버의 네트워크.
  + 이미지, 비디오, CSS, JS 파일 등을 캐시할 수 있다.
- 물리적으로 멀리있는 원본 서버대신 중개 서버를 활용하여 속도의 이점을 얻을 수 있다.
- CDN을 사용하면 정적 콘텐츠는 더 이상 웨 서버를 통해 서비스하지 않는다.
- 캐시된 데이터를 사용하기 때문에 데이터베이스의 부하를 줄여준다.

### CDN 실행 흐름
- CDN 서버의 캐시에 해당 이미지가 없는 경우, CDN 서버는 원본 서버에 요청하여 파일을 가져온다.
- 원본 서버가 CDN 서버에 반환한다. TTL 값이 들어 있다.
- CDN 서버는 파일을 캐시하고 사용자 A에게 반환한다. TTL에 명시된 시간이 끝날 때까지 캐시.

### CDN 사용 시 고려해야할 사항
- 자주 사용되지 않는 콘텐츠를 캐싱하는 것은 별로 도움되지 않으므로 빼는 것이 낫다.
- 너무 길지도 짧지도 않은 시간설정이 중요하다.
- 아직 만료되지 않은 콘테츠라 하더라도 CDN에서 제거할 수 있다.
  + 서비스 사업자가 제공하는 CDN에서 제거
  + 콘텐츠의 다른 버전을 서비스를하도록 오브젝트 버저닝
  + 콘텐츠의 새로운 버전을 지정하기 위해 URL 마지막에 버전 번호를 인자로 추가.

---

## 무상태 웹 계층
- 웹 계층을 수평적으로 확장하기 위해서는 상태 정보를 제거해야한다.
  + 상태 정보, 사용자 세션 데이터
- 상태 정보를 데이터베이스 같은 지속성 저장소에 보관하고, 필요할 때 가져오도록 하는 것이다.

### 상태 정보를 보관하는 서버와 그렇지 않은 서버의 차이
- 상태 정보를 보관하는 서버는 클라이언트 정보와 같은 상태를 유지하여 요청들 사이에 공유되도록 한다.
- 무상태 아키텍처는 상태 정보가 필요한 경우 공유 저장소로부터 데이터를 가져온다.
  + 상태 정보는 웹 서버로부터 분리되어 있다.
  + 해당 구조가 단순하고, 안정적이며, 확장에 용이하다.

---

## 데이터 센터
- 지리적 라우팅, 장애가 없는 상황에서 사용자는 가장 가까운 데이터 센터로 안내
  + DNS 서비스

### 지리적 라우팅을 위해 고려해야하는 요소
- 트래픽 우회, GeoDNS는 사용자에게서 가장 가까운 데이터센터로 트래픽을 보낼 수 있게 한다.
- 데이터 동기화, 데이터 센터마다 다른 DB를 사용하는 상황이라면 데이터를 여러 데이터센터에 걸쳐 다중화.
- 테스트와 배포, 모든 데이터 센터에 동일한 서비스가 설치되도록 하는 것이 중요하다.

---

## 메시지 큐
- 메시지의 무손실을 보장하는, 비동기 통신을 지원하는 컴포넌트다.
- 생산자 또는 발행자라고 불리는 입력 서비스가 메시지를 만들어 메시지 큐에 발행한다.
- 구독자 또는 컨슈머가 서비스 혹은 서버가 연결되어 있는데 메시지를 받아 그에 맞는 동작을 수행하는 역할을 한다.

## 로그, 메트릭 그리고 자동화
- 웹 사이트 규모가 커질수록 로그, 메트릭, 자동화가 중요해진다. 
- 로그 : 시스템의 오류와 문제들을 보다 쉽게 찾아낼 수 있게 해준다.
  + 로그를 단일 서비스로 모아주는 도구를 활용하면 더 편리하게 검색하고 조회할 수 있다.
- 메트릭
  + 호스트 단위 메트릭 : CPU, 메모리, 디스크 I/O에 관한 메트릭이 여기 해당한다.
  + 종합 메트릭 : 데이터베이스 계층의 성능, 캐시 계층의 성능 같은 것이 여기 해당.
  + 핵심 비즈니스 메트릭 : 일별 능동 사용자, 수익, 재방문 같은 것이 여기 해당.
- 자동화
  + 시스템이 크고 복잡해지면 생산성을 높이기 위해 자동화 도구를 활용해야 한다.
  + 빌드, 테스트, 배포 등의 절차를 자동화할 수 있어서 개발 생산성을 크게 향상시킬 수 있다.

---

## 데이터 베이스의 확장
- 수직적 확장과 수평적 확장

### 수직적 확장
- 고성능 자원으로 아마존 AWS에서는 24TB RAN을 갖춘 서버도 상품으로 제공하고 있다
- 최대 성능의 한계가 있다.

### 수평적 확장
- 데이터베이스의 수평적 확장은 샤딩이라고 부른다.
- 샤드에 보관되는 데이터 사이에는 중복이 없다.
  + 4개 라면 id % 4 이런식으로 나눈다.

---

## 정리
- 웹 계층은 무상태 계층으로.
- 모든 계층에 다중화 도입.
- 가능한 한 많은 데이터를 캐시할 것.
- 여러 데이터 센터를 지원할 것.
- 정적 콘텐츠는 CDN을 통해 서버스할 것.
- 데이터 계층은 샤딩을 통해 그 규모를 확장할 것.
- 각 계층은 독립적 서비스로 분할할 것.
- 시스템을 지속적으로 모니터링하고, 자동화 도구를을 활용할 것.